Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.CacheEntry=undefined;var _class2,_temp,_this=this;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _lodash=require('lodash');var _=_interopRequireWildcard(_lodash);var _expoFileSystem=require('expo-file-system');var FileSystem=_interopRequireWildcard(_expoFileSystem);var _sha=require('crypto-js/sha1');var _sha2=_interopRequireDefault(_sha);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var BASE_DIR=FileSystem.cacheDirectory+'expo-image-cache/';var CacheEntry=exports.CacheEntry=function(){function CacheEntry(uri,options){_classCallCheck(this,CacheEntry);this.uri=uri;this.options=options;}_createClass(CacheEntry,[{key:'getPath',value:function getPath(){var uri,options,_ref,path,exists,tmpPath,result;return regeneratorRuntime.async(function getPath$(_context){while(1){switch(_context.prev=_context.next){case 0:uri=this.uri,options=this.options;if(uri){_context.next=3;break;}return _context.abrupt('return',null);case 3:_context.next=5;return regeneratorRuntime.awrap(getCacheEntry(uri));case 5:_ref=_context.sent;path=_ref.path;exists=_ref.exists;tmpPath=_ref.tmpPath;if(!exists){_context.next=11;break;}return _context.abrupt('return',path);case 11:_context.prev=11;_context.next=14;return regeneratorRuntime.awrap(FileSystem.createDownloadResumable(uri,tmpPath,options).downloadAsync());case 14:result=_context.sent;if(!(result&&result.status!==200)){_context.next=17;break;}return _context.abrupt('return',null);case 17:_context.next=24;break;case 19:_context.prev=19;_context.t0=_context['catch'](11);if(!(_context.t0.code==='ENOENT')){_context.next=23;break;}return _context.abrupt('return',null);case 23:console.log(_context.t0);case 24:_context.next=26;return regeneratorRuntime.awrap(FileSystem.moveAsync({from:tmpPath,to:path}));case 26:return _context.abrupt('return',path);case 27:case'end':return _context.stop();}}},null,this,[[11,19]]);}}]);return CacheEntry;}();var CacheManager=(_temp=_class2=function(){function CacheManager(){_classCallCheck(this,CacheManager);}_createClass(CacheManager,null,[{key:'get',value:function get(uri,options){if(!CacheManager.entries[uri]){CacheManager.entries[uri]=new CacheEntry(uri,options);}return CacheManager.entries[uri];}},{key:'clearCache',value:function clearCache(){return regeneratorRuntime.async(function clearCache$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return regeneratorRuntime.awrap(FileSystem.deleteAsync(BASE_DIR,{idempotent:true}));case 2:_context2.next=4;return regeneratorRuntime.awrap(FileSystem.makeDirectoryAsync(BASE_DIR));case 4:case'end':return _context2.stop();}}},null,this);}},{key:'getCacheSize',value:function getCacheSize(){var _ref2,size;return regeneratorRuntime.async(function getCacheSize$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return regeneratorRuntime.awrap(FileSystem.getInfoAsync(BASE_DIR,{size:true}));case 2:_ref2=_context3.sent;size=_ref2.size;return _context3.abrupt('return',size);case 5:case'end':return _context3.stop();}}},null,this);}}]);return CacheManager;}(),_class2.entries={},_temp);exports.default=CacheManager;var getCacheEntry=function getCacheEntry(uri){var filename,ext,_ref3,_exists,path,tmpPath,info,_exists2;return regeneratorRuntime.async(function getCacheEntry$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:filename=void 0;ext=void 0;_context4.prev=2;_context4.next=5;return regeneratorRuntime.awrap(FileSystem.getInfoAsync(BASE_DIR));case 5:_ref3=_context4.sent;_exists=_ref3.exists;if(_exists){_context4.next=10;break;}_context4.next=10;return regeneratorRuntime.awrap(FileSystem.makeDirectoryAsync(BASE_DIR));case 10:_context4.next=15;break;case 12:_context4.prev=12;_context4.t0=_context4['catch'](2);console.log(_context4.t0);case 15:_context4.prev=15;if(uri){_context4.next=18;break;}return _context4.abrupt('return',{exists:false});case 18:filename=uri.substring(uri.lastIndexOf('/'),uri.indexOf('?')===-1?uri.length:uri.indexOf('?'));ext=filename.indexOf('.')===-1?'.jpg':filename.substring(filename.lastIndexOf('.'));_context4.next=25;break;case 22:_context4.prev=22;_context4.t1=_context4['catch'](15);console.log(_context4.t1);case 25:path=''+BASE_DIR+(0,_sha2.default)(uri)+ext;tmpPath=''+BASE_DIR+(0,_sha2.default)(uri)+'-'+_.uniqueId()+ext;_context4.prev=27;_context4.next=30;return regeneratorRuntime.awrap(FileSystem.getInfoAsync(path));case 30:info=_context4.sent;_exists2=info.exists;return _context4.abrupt('return',{exists:_exists2,path:path,tmpPath:tmpPath});case 35:_context4.prev=35;_context4.t2=_context4['catch'](27);if(_context4.t2.code!=='ENOENT'){console.log(_context4.t2);}return _context4.abrupt('return',{exists:false});case 39:case'end':return _context4.stop();}}},null,_this,[[2,12],[15,22],[27,35]]);};
//# sourceMappingURL=CacheManager.js.map